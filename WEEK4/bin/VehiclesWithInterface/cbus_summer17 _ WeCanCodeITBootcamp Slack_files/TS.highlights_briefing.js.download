(function(){"use strict";TS.registerModule("highlights_briefing",{sli_recaps_debug_group:null,sli_highlights_launch_group:null,sli_briefings_dark_test_group:null,updated_sig:new signals.Signal,$briefing_header:null,$briefing_view:null,onStart:function(){if(!TS.client)return;TS.client.ui.unread.started_sig.add(_onEnterView);TS.client.unread.switched_away_sig.add(_resetState);TS.channels.switched_sig.add(_handleChannelSwitch);TS.groups.switched_sig.add(_handleChannelSwitch);TS.channels.marked_sig.add(_handleMarkAsRead);TS.groups.marked_sig.add(_handleMarkAsRead);if(TS.boot_data.feature_sli_highlights_cache){TS.client.highlights.feedback_submitted_sig.add(_handleFeedback)}TS.experiment.loadUserAssignments().then(function(){TS.highlights_briefing.sli_recaps_debug_group=TS.experiment.getGroup("sli_recaps_debug");TS.highlights_briefing.sli_highlights_launch_group=TS.experiment.getGroup("sli_highlights_launch");TS.highlights_briefing.sli_briefings_dark_test_group=TS.experiment.getGroup("sli_briefings_dark_test");var is_in_launch_group=TS.highlights_briefing.isEnabled();var is_in_either_group=is_in_launch_group||TS.highlights_briefing.sli_briefings_dark_test_group==="sli_briefings_dark_test";if(is_in_either_group&&_tried_to_load){_onEnterView()}})},getDebugInfoFor:function(ts,channel_id){return _.get(_cached_messages[channel_id][ts],"score")},getMessageFromCache:function(channel_id,ts){return _.get(_cached_messages,[channel_id,ts],null)},getFeedbackFromCache:function(channel_id,ts){return _.get(_cached_feedback,[channel_id,ts],null)},setFeedbackInCache:function(feedback,ts,channel_id){_setFeedback(feedback,ts,channel_id)},isEnabled:function(){var launch_group_prefix="sli_highlights_launch";return TS.highlights_briefing.sli_highlights_launch_group!==null&&TS.highlights_briefing.sli_highlights_launch_group.substring(0,launch_group_prefix.length)===launch_group_prefix},showBriefing:function(){_$briefing_container.removeClass("hidden");_$briefing_header.toggleClass("hidden",!_interface_state.expanded)},hideBriefing:function(){_$briefing_container.addClass("hidden");_$briefing_header.addClass("hidden")},sendFeedback:function(e,action,ts,model_ob_id,came_from_briefing){if(!TS.highlights_briefing.getMessageFromCache(model_ob_id,ts))return;var existing_feedback=_getFeedback(ts,model_ob_id);if(existing_feedback!=="dismiss"){var $briefing=$('.sli_briefing__message[data-cache-id="'+model_ob_id+"-"+ts+'"]');var message=_.get(_cached_messages,[model_ob_id,ts]);if(action==="dismiss"){_feedbackAndDismiss($briefing,action,ts,model_ob_id);var feedback_args=_.assign({},message.feedback_options.dismiss.args,{request_id:message.request_id});if(message.cached_request_id){feedback_args.cached_request_id=message.cached_request_id}TS.api.call("highlights.feedback",feedback_args)}else if(action==="negative"){$briefing.find("ts-message").addClass("hidden");$briefing.addClass("gave_negative_feedback");$briefing.find('[data-highlight-feedback="negative"]').addClass("sli_briefing__feedback_control--pulse");$('[data-feedback-for-cache-id="'+model_ob_id+"-"+ts+'"]').removeClass("hidden");_setFeedback("negative",ts,model_ob_id);if(came_from_briefing){var default_negative_feedback_args=_.assign({},message.feedback_options.default_negative.args,{request_id:message.request_id});if(message.cached_request_id){default_negative_feedback_args.cached_request_id=message.cached_request_id}TS.api.call("highlights.feedback",default_negative_feedback_args)}}else if(action==="positive"){$briefing.addClass("gave_positive_feedback");$briefing.find('[data-highlight-feedback="positive"]').addClass("sli_briefing__feedback_control--pulse");_setFeedback("positive",ts,model_ob_id);if(came_from_briefing){var default_positive_feedback_args=_.assign({},message.feedback_options.default_positive.args,{request_id:message.request_id});if(message.cached_request_id){default_positive_feedback_args.cached_request_id=message.cached_request_id}TS.api.call("highlights.feedback",default_positive_feedback_args)}}}},handleSecondaryFeedbackMenuClick:function(index,model_ob_id,ts,no_api_call){var message=_.get(_cached_messages,[model_ob_id,ts]);if(!message){return}var feedback_args=_.get(message,["feedback_options","negative",index,"args"]);if(message&&feedback_args){if(!no_api_call){_.assign(feedback_args,{request_id:message.request_id});if(message.cached_request_id){feedback_args.cached_request_id=message.cached_request_id}TS.api.call("highlights.feedback",feedback_args)}var $briefing=$('.sli_briefing__message[data-cache-id="'+model_ob_id+"-"+ts+'"]');_feedbackAndDismiss($briefing,"dismiss",ts,model_ob_id)}},jumpToMessageInChannel:function(channel_id,ts){_jumpToMessageInChannel(channel_id,ts)},setUnreadPointOnMessage:function(msg_ts){msg_ts=String(msg_ts);var $message=$('.sli_briefing__message ts-message[data-ts="'+msg_ts+'"]');if($message.length){var model_ob_id=$message.data("model-ob-id");TS.shared.markReadMsg(model_ob_id,msg_ts,TS.model.marked_reasons.back);TS.client.markLastReadsWithAPI();_handleMarkAsRead(TS.shared.getModelObById(model_ob_id))}}});var _$briefing_container=null;var _$briefing_view=null;var _$briefing_preview_container=null;var _$briefing_header=null;var _cached_messages={};var _cached_feedback={};var _interface_state={expanded:false,scroll_top:0,last_jump:{ts:null,model_ob_id:null},show_briefing_back_button:false,last_open_ts:null,loading:true};var _tried_to_load=false;var _last_request_id=null;var _cached_headline={};var _onEnterView=function(){if(TS.highlights_briefing.sli_highlights_launch_group===null&&TS.highlights_briefing.sli_briefings_dark_test_group===null){_tried_to_load=true;return}if(!TS.highlights_briefing.isEnabled()){if(TS.highlights_briefing.sli_briefings_dark_test_group==="sli_briefings_dark_test"){TS.api.call("highlights.briefing")}return}if(_interface_state.show_briefing_back_button||_.get(_interface_state,["last_jump","model_ob_id"])){_hideBackButtonInChannel()}_interface_state.briefing_opens_count=TS.storage.fetchBriefingOpensCount();_interface_state.loading=true;_createBriefingContainer();TS.api.call("highlights.briefing").then(TS.boot_data.feature_sli_highlights_cache?_processMessagesWithHighlightsCache:_processMessages).then(_renderBriefing).catch(function(err){TS.error("A call to highlights.briefing failed:");TS.error(err);_renderCollapsedView(null,0,false,true)});_bindUi()};var _processMessages=function(d){if(_.get(d,"data.messages.length")){d.data.messages=_.map(d.data.messages,function(message){var normalized_msg=TS.utility.msgs.processImsg(message,message.channel_id);normalized_msg.channel=message.channel;normalized_msg.channel_id=message.channel_id;normalized_msg.justification=TS.format.formatWithOptions(message.justification||"",message,{no_linking:true});normalized_msg.score=message.score;normalized_msg.feedback_options=message.feedback_options;normalized_msg.request_id=message.request_id;normalized_msg.cached_request_id=message.cached_request_id;normalized_msg.is_briefing_message=true;return normalized_msg})}return d};var _processMessagesWithHighlightsCache=function(d){var highlights={};if(_.get(d,"data.messages.length")){d.data.messages=_.map(d.data.messages,function(message){var channel_id=message.channel_id;var normalized_msg=TS.utility.msgs.processImsg(message,channel_id);normalized_msg.channel_id=channel_id;var recap={};recap.show_recap=true;recap.score=message.score;recap.feedback_options=message.feedback_options;recap.request_id=message.request_id;recap.cached_request_id=message.cached_request_id;recap.justification=message.justification;highlights[channel_id]=highlights[channel_id]||{};highlights[channel_id][message.ts]=recap;return normalized_msg});TS.client.highlights.addHighlights(highlights)}return d};var _createBriefingContainer=function(){$("#unread_msgs_div").before(TS.templates.sli_briefing({show_onboarding:_interface_state.briefing_opens_count<3}));$("#unread_msgs_scroller_div").prepend(TS.templates.sli_briefing_header())};var _renderBriefing=function(d){_last_request_id=d.request_id;_interface_state.loading=false;if(_interface_state.last_open_ts!==null&&_interface_state.last_open_ts<Date.now()-15*1e3*60){_interface_state.expanded=false}if(_.get(d,"data.messages.length")){var grouped_by_channel=_.groupBy(d.data.messages,"channel_id");var rendered_message_groups=_(grouped_by_channel).map(function(group,key){var channel_group={channel:TS.shared.getModelObById(key),messages:_(group).map(TS.boot_data.feature_sli_highlights_cache?_makeRenderContextForMessageWithHighlight:_makeRenderContextForMessage).compact().value()};if(!channel_group.messages.length){return null}return channel_group}).compact().value();if(rendered_message_groups.length){_cacheMessages(d.data.messages);_$briefing_view.find(".sli_briefing_view__messages").html(TS.templates.sli_briefing_message_view({groups:rendered_message_groups}))}}else{_cached_messages={}}if(d.data.headline){_cached_headline={header:TS.format.formatWithOptions(d.data.headline.header||"","",{no_linking:true}),subheader:TS.format.formatWithOptions(d.data.headline.subheader||"","",{no_linking:true})};_renderFacepile(d.data.headline.users)}else{_cached_headline={header:"",subheader:""}}var active_briefing_count=_getActiveBriefingCount();if(_interface_state.expanded&&active_briefing_count){_openBriefingWithAnimation(false)}else if(_interface_state.expanded&&!active_briefing_count){_interface_state.expanded=false;_$briefing_preview_container.removeClass("hidden");_$briefing_view.addClass("hidden");_$briefing_header.addClass("hidden");_renderCollapsedView(null,0,true)}else{var headline=_getCurrentHeadline();_renderCollapsedView(headline,_getActiveBriefingCount())}var last_jump_channel=_.get(_interface_state,["last_jump","model_ob_id"]);var last_jump_ts=_.get(_interface_state,["last_jump","ts"]);if(_.get(_cached_messages,[last_jump_channel,last_jump_ts])){_interface_state.scroll_top=0;_interface_state.last_jump.ts=null;_interface_state.last_jump.model_ob_id=null}TS.highlights_briefing.updated_sig.dispatch()};var _renderBriefingMessage=function(message){var channel_ob;if(TS.boot_data.feature_sli_highlights_cache){channel_ob=TS.shared.getModelObById(message.channel_id)}else{channel_ob=message.channel}var $msg=$(TS.templates.builders.msgs.buildHTML({msg:message,model_ob:channel_ob,enable_slack_action_links:true,container_id:"sli_briefing",prev_msg:null,briefing:true}));if(message.pinned_to&&message.pinned_to.length||_.get(message,"file.pinned_to.length"))$msg.removeClass("is_pinned");$msg.addClass("is_sli_briefing");return $msg[0].outerHTML};var _makeRenderContextForMessage=function(message){var feedback=_getFeedback(message.ts,message.channel.id);var feedback_class=_getFeedbackClass(feedback);if(feedback&&feedback!=="jump"&&feedback!=="positive")return null;var negative_feedback_options=_.map(message.feedback_options.negative,function(item){return _.assign({},item,{text:new Handlebars.SafeString(TS.format.formatWithOptions(item.text,null,{no_linking:true}))})});return{message_markup:_renderBriefingMessage(message),message:message,justification:message.justification?new Handlebars.SafeString(message.justification):null,feedback_class:feedback_class,negative_feedback_options:negative_feedback_options}};var _makeRenderContextForMessageWithHighlight=function(message){var recap=TS.client.highlights.getHighlight(message.channel_id,message.ts);if(recap.feedback&&recap.feedback!=="positive")return null;var feedback_class=_getFeedbackClass(recap.feedback);var negative_feedback_options=_.map(recap.feedback_options.negative,function(item){return _.assign({},item,{text:new Handlebars.SafeString(TS.format.formatWithOptions(item.text,null,{no_linking:true}))})});return{message_markup:_renderBriefingMessage(message),message:message,justification:recap.justification,feedback_class:feedback_class,negative_feedback_options:negative_feedback_options}};var _renderCollapsedView=function(headline,count,cleared,error){if(headline&&count){_$briefing_preview_container.removeClass("sli_briefing_preview--loading").addClass("sli_briefing_preview--has_briefings");_$briefing_preview_container.find('[data-js="sli_briefing_preview_title"]').html(headline.header);_$briefing_preview_container.find('[data-js="sli_briefing_preview_description"]').html(headline.subheader);_$briefing_preview_container.find('[data-js="sli_briefing_preview_action"]').removeClass("hidden");_$briefing_preview_container.find('[data-js="sli_briefing_preview_facepile"]').removeClass("hidden")}else if(cleared){_$briefing_preview_container.removeClass("sli_briefing_preview--loading sli_briefing_preview--has_briefings").addClass("sli_briefing_preview--empty");_$briefing_preview_container.find('[data-js="sli_briefing_preview_title"]').text(TS.i18n.t("That’s it!","highlights")());_$briefing_preview_container.find('[data-js="sli_briefing_preview_description"]').text(TS.i18n.t("Check back later for more.","highlights")());_$briefing_preview_container.find('[data-js="sli_briefing_preview_action"]').addClass("hidden");_$briefing_preview_container.find('[data-js="sli_briefing_preview_facepile"]').addClass("hidden")}else if(!error){_$briefing_preview_container.removeClass("sli_briefing_preview--loading sli_briefing_preview--has_briefings").addClass("sli_briefing_preview--empty");_$briefing_preview_container.find('[data-js="sli_briefing_preview_title"]').text(TS.i18n.t("No new highlights","highlights")());_$briefing_preview_container.find('[data-js="sli_briefing_preview_description"]').text(_getRandomTip());_$briefing_preview_container.find('[data-js="sli_briefing_preview_action"]').addClass("hidden")}else{_$briefing_preview_container.removeClass("sli_briefing_preview--loading sli_briefing_preview--has_briefings").addClass("sli_briefing_preview--empty");_$briefing_preview_container.find('[data-js="sli_briefing_preview_title"]').removeClass("small_bottom_margin").addClass("error no_bottom_margin").text(TS.i18n.t("Couldn’t load highlights","highlights")());_$briefing_preview_container.find('[data-js="sli_briefing_preview_description"]').addClass("hidden");_$briefing_preview_container.find('[data-js="sli_briefing_preview_action"]').addClass("hidden")}TS.highlights_briefing.updated_sig.dispatch()};var _renderFacepile=function(user_ids){var facepile_markup=_.map(user_ids,function(id){var member=TS.members.getMemberById(id);return TS.templates.builders.makeMemberPreviewLinkImage(member,24,false,true,true,true)}).join("");_$briefing_preview_container.find('[data-js="sli_briefing_preview_facepile"]').html(facepile_markup)};var _getRandomTip=function(){var strings=[TS.i18n.t("Slack’s a fast learner: when you leave feedback on a highlight, we’ll adjust.","highlights")(),TS.i18n.t("But we’ll keep an ear to the ground.","highlights")()];return strings[_.random(strings.length-1)]};var _cacheMessages=function(messages){_cached_messages={};_.forEach(messages,function(message){_cached_messages[message.channel_id]=_cached_messages[message.channel_id]||{};_cached_messages[message.channel_id][message.ts]=message;if(TS.boot_data.feature_sli_highlight_unreads&&TS.client.ui.sli_highlight_all_unreads){TS.client.ui.sli_highlight_all_unreads.setRecapCache(message.channel_id,message.ts,_.assign({},message.score,{justification:message.justification,request_id:message.request_id,cached_request_id:message.cached_request_id,feedback_options:message.feedback_options,from_briefing:true}))}})};var _resetState=function(){if(!TS.highlights_briefing.isEnabled())return;_unbindUi();_$briefing_container=null;_$briefing_view=null;_$briefing_preview_container=null;_$briefing_header=null;TS.highlights_briefing.$briefing_header=null;TS.highlights_briefing.$briefing_view=null;_last_request_id=null;_cached_headline=null;_interface_state.last_open_ts=Date.now();if(!TS.boot_data.feature_sli_highlights_cache){_.each(_cached_feedback,function(channel){_.each(channel,function(feedback,ts){if(feedback==="negative"){channel[ts]="dismiss"}})})}};var _getActiveBriefingCount=function(){return _.reduce(_cached_messages,function(channel_sum,channel_messages){return channel_sum+_.reduce(channel_messages,function(messages_sum,message){if(message._removed||_getFeedback(message.ts,message.channel_id)==="dismiss"){return messages_sum}return messages_sum+1},0)},0)};var _getActiveBriefings=function(){return _(_cached_messages).flatMap(function(messages){return _.map(messages,function(message){if(message._removed||_getFeedback(message.ts,message.channel_id)==="dismiss"){return null}return message})}).compact().value()};var _getCurrentHeadline=function(){return _cached_headline};var _setFeedback=function(action,ts,model_ob_id){if(TS.boot_data.feature_sli_highlights_cache)return;if(!_cached_feedback[model_ob_id])_cached_feedback[model_ob_id]={};_cached_feedback[model_ob_id][ts]=action};var _getFeedback=function(ts,model_ob_id){if(TS.boot_data.feature_sli_highlights_cache){return _.get(TS.client.highlights.getHighlight(model_ob_id,ts),"feedback")}return _.get(_cached_feedback,[model_ob_id,ts])};var _getFeedbackClass=function(action){if(action==="negative")return"gave_negative_feedback";if(action==="positive")return"gave_positive_feedback";if(action==="dismiss")return"sli_briefing__feedback--dismiss";return""};var _handleChannelSwitch=function(){if(!TS.highlights_briefing.isEnabled())return;if(TS.model.active_cid===_.get(_interface_state,["last_jump","model_ob_id"])&&_interface_state.show_briefing_back_button){_showBackButtonInChannel()}else if(_interface_state.last_jump&&_interface_state.show_briefing_back_button){_hideBackButtonInChannel()}};var _showBackButtonInChannel=function(){$(".sli_briefing__channel_back_button").removeClass("hidden");$("#messages_unread_status").addClass("sli_briefing--has_back_button")};var _hideBackButtonInChannel=function(){$(".sli_briefing__channel_back_button").addClass("hidden");$("#messages_unread_status").removeClass("sli_briefing--has_back_button");_interface_state.show_briefing_back_button=false};var _clogFeedback=function(action,msg_ts,channel_id){if(action==="dismiss"){var clog_args={request_id:_last_request_id,message_timestamp:msg_ts,channel_id:channel_id,channel_type:channel_id[0]||""};var cached_request_id;if(TS.boot_data.feature_sli_highlights_cache){var recap=TS.client.highlights.getHighlight(channel_id,msg_ts);cached_request_id=recap.cached_request_id}else{cached_request_id=_.get(_cached_messages,[channel_id,msg_ts,"cached_request_id"])}if(cached_request_id){clog_args.cached_request_id=cached_request_id}TS.clog.track("MSG_BRIEFING_DISMISS",clog_args)}};var _bindUi=function(){_$briefing_container=$("#sli_briefing");_$briefing_view=$("[data-js=sli_briefing_view]");_$briefing_preview_container=$('[data-js="sli_briefing_preview_container"]');_$briefing_header=$('[data-js="sli_briefing_header"]');TS.highlights_briefing.$briefing_header=_$briefing_header;TS.highlights_briefing.$briefing_view=_$briefing_view;_$briefing_container.on("click",".sli_briefing__message ts-message, .sli_briefing_target",function(e){if(!$(e.target).is("ts-message, .message_content, .message_body, .message_content_header_left, .sli_briefing_target, .comment, .rxn_panel")&&!$(e.target).parents(".message_body").length||$(e.target).parents(".msg_inline_file_preview_toggler").length||$(e.target).is("a")&&$(e.target).closest(".message_body").length||$(e.target).closest(".attachment_media").length){return}var $message=$(this).is("ts-message")?$(this):$(this).parents("ts-message");var msg_ts=$message.data("ts")+"";var model_ob_id=$message.data("model-ob-id")+"";_jumpToMessageInChannel(model_ob_id,msg_ts)});_$briefing_container.on("click",".sli_briefing__channel_link .channel_link",function(e){var channel_id=$(e.target).data("channel-id");if(channel_id[0]==="G"){TS.groups.displayGroup({id:channel_id})}});_$briefing_container.on("click",'[data-js="sli_briefing_preview"]',function(){if(_interface_state.loading)return;_interface_state.expanded=true;_interface_state.briefing_opens_count+=1;TS.storage.storeBriefingOpensCount(_interface_state.briefing_opens_count);_openBriefingWithAnimation(true);var payload={request_id:_last_request_id};var cached_channel_id=_.keys(_cached_messages)[0];var cached_msg_ts=_.keys(_.get(_cached_messages,[cached_channel_id]))[0];var cached_request_id;if(TS.boot_data.feature_sli_highlights_cache){var recap=TS.client.highlights.getHighlight(cached_channel_id,cached_msg_ts);cached_request_id=recap.cached_request_id}else{cached_request_id=_.get(_cached_messages,[cached_channel_id,cached_msg_ts,"cached_request_id"])}if(cached_request_id){payload.cached_request_id=cached_request_id}TS.clog.track("BRIEFING_REVEAL",payload);TS.highlights_briefing.updated_sig.dispatch()});_$briefing_header.off("click").on("click",'[data-js="sli_briefing_header_dismiss_all"]',function(){_interface_state.expanded=false;_closeBriefingWithAnimation();var briefings=_getActiveBriefings();var briefing_message_stubs=_.map(briefings,function(message){return{channel_id:message.channel_id,ts:message.ts}});TS.api.call("highlights.dismissAll",{request_id:_last_request_id,messages:JSON.stringify(briefing_message_stubs)}).catch(function(e){TS.error(e)})});_$briefing_container.on("click",'[data-js="sli_briefing_feedback_item"] a',function(e){e.preventDefault();var cache_id=($(e.target).closest(".sli_briefing__feedback_leavebehind").data("feedback-for-cache-id")||"").split("-");var item_index=Number($(e.target).closest("li").data("index"));var model_ob_id=cache_id[0];var ts=cache_id[1];if(TS.boot_data.feature_sli_highlights_cache){TS.client.highlights.setNegativeFeedbackForHighlight(model_ob_id,ts,item_index)}else{TS.highlights_briefing.handleSecondaryFeedbackMenuClick(item_index,model_ob_id,ts)}});_$briefing_container.on("click","[data-feedback]",function(e){e.preventDefault();var type=$(e.target).data("feedback");var $briefing=$(e.target).closest(".sli_briefing__message");var cache_id=($briefing.data("cache-id")||"").split("-");var model_ob_id=cache_id[0];var ts=cache_id[1];if(TS.boot_data.feature_sli_highlights_cache){TS.client.highlights.setDefaultFeedbackForHighlight(model_ob_id,ts,{feedback:type})}else{TS.highlights_briefing.sendFeedback(e,type,ts,model_ob_id);if(TS.boot_data.feature_sli_highlight_unreads&&TS.client.ui.sli_highlight_all_unreads){TS.client.ui.sli_highlight_all_unreads.sendFeedback(e,type,ts,model_ob_id)}}})};var _handleFeedback=function(highlight){if(!TS.model.unread_view_is_showing)return;_.each(highlight,function(recaps,channel){_.each(recaps,function(recap,ts){if(_cached_messages[channel]&&_cached_messages[channel][ts]){var $briefing=$('[data-cache-id="'+channel+"-"+ts+'"]');if($briefing.length)_handleFeedbackOfType($briefing,channel,ts,recap)}})})};var _handleFeedbackOfType=function($briefing,channel_id,msg_ts,recap){if(recap.feedback==="dismiss"||!recap.is_leaving_feedback&&recap.left_feedback){_dismissMessage($briefing,channel_id,function(){if(_haveAllMessagesBeenDismissed()){_showEmptyState()}});_clogFeedback("dismiss",msg_ts,channel_id)}else if(recap.feedback==="negative"&&recap.is_leaving_feedback){$briefing.find("ts-message").addClass("hidden");$briefing.addClass("gave_negative_feedback");$briefing.find('[data-feedback="negative"]').addClass("sli_briefing__feedback_control--pulse");$('[data-feedback-for-cache-id="'+channel_id+"-"+msg_ts+'"]').removeClass("hidden")}else if(recap.feedback==="positive"){$briefing.addClass("gave_positive_feedback");$briefing.find('[data-feedback="positive"]').addClass("sli_briefing__feedback_control--pulse")}};var _openBriefingWithAnimation=function(has_animation){var old_height=_$briefing_container.outerHeight();var $preview_container=$('[data-js="sli_briefing_preview_container"]');var header_height=61;_$briefing_view.removeClass("hidden");_$briefing_header.removeClass("hidden");TS.client.ui.checkInlineImgsAndIframes("unread");if(has_animation){$preview_container.css({height:0,"margin-top":(TS.environment.supports_sticky_position?-header_height:0)+"px"});var new_height=_$briefing_container.outerHeight();_$briefing_container.css({height:old_height,"padding-top":header_height+16+"px","margin-top":-header_height+"px"});_$briefing_container.animate({height:new_height+header_height},300,function(){_$briefing_container.css({height:"auto","margin-top":"","padding-top":TS.environment.supports_sticky_position?header_height+16+"px":""});_$briefing_view.find(".sli_briefing__channel, .sli_briefing_view__footer").each(function(i,el){setTimeout(function(){$(el).css("opacity",1)},100*i+200)});if(_interface_state.briefing_opens_count===1){setTimeout(function(){TS.coachmark.start(TS.coachmarks.coachmarks.highlights_feedback)},400)}})}else{$preview_container.css({transition:"none",height:0,"margin-top":(TS.environment.supports_sticky_position?-header_height:0)+"px"});_$briefing_header.css("transition","none");_$briefing_view.find(".sli_briefing__channel, .sli_briefing_view__footer").css("opacity",1);_$briefing_container.css({height:"auto","margin-top":"","padding-top":TS.environment.supports_sticky_position?header_height+16+"px":""})}$preview_container.addClass("go-away");_$briefing_header.addClass("expand");if(!has_animation){setTimeout(function(){_$briefing_header.css("transition","");$preview_container.css("transition","")},0)}};var _closeBriefingWithAnimation=function(){var $preview_container=$('[data-js="sli_briefing_preview_container"]');_$briefing_header.removeClass("expand").addClass("go-away");var old_height=_$briefing_container.outerHeight();_$briefing_view.css({opacity:0});_renderCollapsedView(null,0,true);var new_height=166;_$briefing_container.css({height:old_height,"margin-top":TS.environment.supports_sticky_position?"-61px":""});_$briefing_container.animate({height:new_height},300);$preview_container.css({transition:"none",transform:"translateY(118px)"});setTimeout(function(){$preview_container.css({transition:"",transform:"translateY(0)",opacity:1,"pointer-events":""})},0)};var _unbindUi=function(){_$briefing_container.off("click");_$briefing_header.off("click")};var _jumpToMessageInChannel=function(model_ob_id,msg_ts){var request_id;var cached_request_id;if(TS.boot_data.feature_sli_highlights_cache){var recap=TS.client.highlights.getHighlight(model_ob_id,msg_ts);request_id=recap.request_id;cached_request_id=recap.cached_request_id}else{request_id=_.get(_cached_messages,[model_ob_id,msg_ts,"request_id"]);cached_request_id=_.get(_cached_messages,[model_ob_id,msg_ts,"cached_request_id"])}_interface_state.scroll_top=TS.client.ui.unread.$scroller.scrollTop();_interface_state.last_jump={ts:msg_ts,model_ob_id:model_ob_id};_interface_state.show_briefing_back_button=true;if(!TS.boot_data.feature_sli_highlights_cache){TS.recaps_signal.markMessagesAsHighlights(_.toArray(_cached_messages[model_ob_id]),model_ob_id)}TS.client.ui.tryToJump(model_ob_id,msg_ts);var payload={channel_id:model_ob_id,channel_type:model_ob_id[0]||"",message_timestamp:msg_ts,request_id:request_id};if(cached_request_id){payload.cached_request_id=cached_request_id}TS.clog.track("BRIEFING_JUMP_TO_CHANNEL",payload)};var _dismissMessage=function($briefing,model_ob_id,callback){$briefing.addClass(_getFeedbackClass("dismiss"));setTimeout(function(){$briefing.css({transition:"margin-bottom 0.3s","margin-bottom":0});$briefing.animate({height:0},300,function(){var $parent=$briefing.parents('.sli_briefing__channel[data-channel-id="'+model_ob_id+'"]');$briefing.remove();if(_haveAllMessagesBeenDismissedInChannel(model_ob_id)){$parent.css({transition:"opacity 0.2s",opacity:.5})}if(callback)callback()})},300)};var _haveAllMessagesBeenDismissedInChannel=function(model_ob_id){if(TS.boot_data.feature_sli_highlights_cache){return _.every(_cached_messages[model_ob_id],function(message,ts){var recap=TS.client.highlights.getHighlight(model_ob_id,ts);return!recap||recap.feedback==="dismiss"})}return _.every(_cached_messages[model_ob_id],function(message,ts){return _cached_feedback[model_ob_id][ts]==="dismiss"})};var _haveAllMessagesBeenDismissed=function(){return _.every(_cached_messages,function(messages,channel){return _.every(_cached_messages[channel],function(message,ts){var recap=TS.client.highlights.getHighlight(channel,ts);if(!recap)return true;return recap.feedback==="dismiss"||recap.left_feedback===true})})};var _showEmptyState=function(){_$briefing_container.replaceWith(TS.templates.sli_briefing());_$briefing_header.addClass("hidden");_bindUi();_renderCollapsedView(null,0,true);_interface_state.expanded=false};var _feedbackAndDismiss=function($briefing,action,ts,model_ob_id){_setFeedback(action,ts,model_ob_id);_clogFeedback(action,ts,model_ob_id);_dismissMessage($briefing,model_ob_id,function(){if(!_getActiveBriefingCount()){_showEmptyState()}})};var _handleMarkAsRead=function(channel){if(!TS.highlights_briefing.isEnabled())return;if(!TS.model.unread_view_is_showing)return;if(!channel||!_cached_messages||_.isEmpty(_cached_messages)||!_cached_messages[channel.id])return;_.each(_cached_messages[channel.id],function(message,ts){if(ts<channel.last_read&&!message._removed){TS.client.highlights.setDefaultFeedbackForHighlight(channel.id,ts,{feedback:"dismiss"})}})}})();
